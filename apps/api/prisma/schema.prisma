// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  output          = "../generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// call analysi
generator json {
  provider = "prisma-json-types-generator"
}

model Company {
  id            String   @id @default(cuid())
  name          String
  connectwiseId String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  calls         Call[]
  CallAnalysis  CallAnalysis[]
  processingLog ProcessingLog[]
}

model Agent {
  id                    String         @id @default(cuid())
  name                  String
  email                 String?
  extension             String?        @unique
  entraUserId           String?        @unique // Link to EntraUser for login account mapping
  entraUser             EntraUser?     @relation(fields: [entraUserId], references: [id])
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  calls                 Call[]         @relation("PrimaryAgent")
  transferredCalls      Call[]         @relation("TransferredToAgent") // Calls transferred TO this agent
  keywordAlerts         KeywordAlert[]
  userAccess            UserAgentAccess[]

  @@index([entraUserId])
}

model Call {
  id                  String    @id @default(cuid())
  companyId           String?
  callSid             String
  callStatus          String
  callDirection       String?   // INBOUND, OUTBOUND, INTERNAL, UNKNOWN
  externalPhoneNumber String?   // The external party's phone number (client/prospect)
  startTime           DateTime
  endTime             DateTime?
  duration            Int?
  recordingUrl        String?
  transcriptUrl       String? // Path to the transcript in blob storage
  processingMetadata  Json?   // LLM provider/model info for each pipeline step
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Transfer/grouping fields
  callerIdInternal    String?   // Original caller ID that persists through transfers (links call legs)
  callGroupId         String?   // Shared ID for grouped/transferred calls
  callLegOrder        Int?      // Position in transfer chain (1=first leg, 2=second, etc.)
  sourceType          String?   // VoIP stype: external, queue, phone, api, etc.
  destinationType     String?   // VoIP dtype: phone, external, number, etc.
  sourceNumber        String?   // VoIP snumber (who initiated this leg)
  destinationNumber   String?   // VoIP dnumber (where this leg went)

  company Company? @relation(fields: [companyId], references: [id])

  analysis                CallAnalysis?             @relation(fields: [callAnalysisId], references: [id])
  callAnalysisId          String?                   @unique
  processingLog           ProcessingLog[]
  Agents                  Agent?                    @relation("PrimaryAgent", fields: [agentsId], references: [id])
  agentsId                String?
  
  // Transfer detection - secondary agent who received the call via transfer
  TransferredToAgent      Agent?                    @relation("TransferredToAgent", fields: [transferredToAgentId], references: [id])
  transferredToAgentId    String?
  transferDetectedAt      DateTime?                 // When the transfer was detected
  transferNote            String?                   // Optional note about the transfer (e.g., "Detected from transcript")
  
  CallTranscriptEmbedding CallTranscriptEmbedding[]
  keywordAlerts           KeywordAlert[]
  sentimentAlerts         SentimentAlert[]

  @@index([companyId])
  @@index([callerIdInternal])
  @@index([callGroupId])
}

model CallAnalysis {
  id                String             @id @default(cuid())
  companyId         String?
  callId            String
  /// [CallAnalysisData]
  data              Json
  promptTemplateId  String?
  llmConfigId       String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  Company           Company?           @relation(fields: [companyId], references: [id])
  Call              Call?
  promptTemplate    PromptTemplate?    @relation("PromptUsedInCall", fields: [promptTemplateId], references: [id])
  llmConfig         LLMConfiguration?  @relation("LLMUsedInCall", fields: [llmConfigId], references: [id])
  evaluations       TrainingRuleEvaluation[]

  @@index([callId])
  @@index([promptTemplateId])
  @@index([llmConfigId])
}

model ProcessingLog {
  id        String   @id @default(cuid())
  companyId String?
  callId    String
  status    String
  message   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Company Company? @relation(fields: [companyId], references: [id])
  Call    Call?    @relation(fields: [callId], references: [id])

  @@index([companyId])
}

model CallTranscriptEmbedding {
  id            String                      @id @default(cuid())
  createdAt     DateTime                    @default(now())
  updatedAt     DateTime                    @updatedAt
  call          Call                        @relation(fields: [callId], references: [id])
  callId        String // Foreign key to Call
  chunkSequence Int // Order of this chunk within the call's transcript
  embedding     Unsupported("vector(1536)") // For OpenAI text-embedding-ada-002
  modelName     String // e.g., "text-embedding-ada-002"

  @@unique([callId, chunkSequence])
  @@index([callId])
  @@index([callId, chunkSequence])
}

// User management for Entra ID authenticated users
model EntraUser {
  id           String    @id @default(cuid())
  oid          String?   @unique // Object ID from Microsoft Entra ID
  email        String    @unique
  displayName  String?
  department   String?
  role         String    @default("user") // 'admin', 'manager', 'team_lead', 'user'
  contextBox   String?   @db.Text // Free text: role, purpose, skills, extension info
  enabled      Boolean   @default(true) // Can be disabled by admin
  lastLoginAt  DateTime?
  lastSyncedAt DateTime  @default(now())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  agent        Agent?    // Reverse relation for agent mapping

  permissionOverrides UserPermissionOverride[]
  agentAccess         UserAgentAccess[]
  auditLogs           AuditLog[]

  @@index([email])
  @@index([oid])
  @@index([role])
  @@map("entra_users")
}

// Audit trail for compliance and security
model AuditLog {
  id         String   @id @default(cuid())
  timestamp  DateTime @default(now())
  actorId    String?                      // User who performed action (null for system)
  actorEmail String?                      // Denormalized for quick display
  action     String                       // e.g., "auth.login", "call.view", "permission.grant"
  targetType String?                      // e.g., "call", "user", "permission", "config"
  targetId   String?                      // ID of affected entity
  targetName String?                      // Denormalized name for display
  metadata   Json?                        // Additional context (IP, old/new values, etc.)

  actor      EntraUser? @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([timestamp])
  @@index([actorId])
  @@index([action])
  @@index([targetType, targetId])
  @@map("audit_logs")
}

// Granular permission definitions
model Permission {
  code        String   @id              // "admin.users", "calls.view", etc.
  name        String                    // "User Management", "View Calls"
  category    String                    // "admin", "calls", "training", "dashboard"
  description String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  rolePermissions RolePermission[]
  userOverrides   UserPermissionOverride[]

  @@index([category])
  @@map("permissions")
}

// Permissions assigned to roles
model RolePermission {
  id             String     @id @default(cuid())
  role           String                    // "admin", "manager", "team_lead", "user"
  permissionCode String
  permission     Permission @relation(fields: [permissionCode], references: [code], onDelete: Cascade)
  createdAt      DateTime   @default(now())

  @@unique([role, permissionCode])
  @@index([role])
  @@map("role_permissions")
}

// Per-user permission overrides (grant or revoke)
model UserPermissionOverride {
  id             String     @id @default(cuid())
  userId         String
  permissionCode String
  granted        Boolean                   // true = grant, false = revoke
  user           EntraUser  @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission     Permission @relation(fields: [permissionCode], references: [code], onDelete: Cascade)
  createdAt      DateTime   @default(now())

  @@unique([userId, permissionCode])
  @@index([userId])
  @@map("user_permission_overrides")
}

// Prompt templates for AI operations
model PromptTemplate {
  id          String   @id @default(cuid())
  name        String
  useCase     String // TRANSCRIPTION_REFINEMENT, CALL_ANALYSIS, CUSTOM
  content     String   @db.Text
  isActive    Boolean  @default(false)
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?

  usedInCalls CallAnalysis[] @relation("PromptUsedInCall")

  @@index([useCase])
  @@index([isActive])
  @@map("prompt_templates")
}

// LLM configuration for different use cases
model LLMConfiguration {
  id          String   @id @default(cuid())
  name        String
  useCase     String // TRANSCRIPTION, TRANSCRIPTION_REFINEMENT, CALL_ANALYSIS, EMBEDDINGS
  modelName   String
  provider    String   @default("openai")
  isActive    Boolean  @default(false)
  settings    Json // { temperature, max_tokens, top_p, frequency_penalty, etc. }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?

  usedInCalls CallAnalysis[] @relation("LLMUsedInCall")

  @@index([useCase])
  @@index([isActive])
  @@map("llm_configurations")
}

// Department-level keyword triggers for training alerts
model DepartmentKeywordTrigger {
  id              String   @id @default(cuid())
  department      String?
  keyword         String
  isActive        Boolean  @default(true)
  triggerType     String   @default("TRAINING_ALERT")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?

  triggeredAlerts KeywordAlert[]

  @@index([department])
  @@index([isActive])
  @@map("department_keyword_triggers")
}

// Singleton company info for LLM prompt injection
model CompanyInfo {
  id                String   @id @default(cuid())
  name              String   // "Ingenio Technologies Ltd"
  description       String   @db.Text  // What the company does
  industry          String?  // "IT Managed Services Provider (MSP)"
  location          String?  // "Brighton, East Sussex, UK"
  website           String?
  additionalContext String?  @db.Text // Free text for anything else
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  updatedBy         String?

  @@map("company_info")
}

// Training rules for LLM call analysis evaluation
model TrainingRule {
  id          String   @id @default(cuid())
  title       String   // Short name, e.g. "No understaffing disclosure"
  description String   @db.Text // Full rule text for the LLM
  category    String   @default("general") // e.g. "compliance", "customer_service", "sales"
  department  String?  // Optional: only apply to calls from this department
  isActive    Boolean  @default(true)
  isCritical  Boolean  @default(false) // Auto-fail flag for future scoring
  weight      Int      @default(10) // Weight within category (0-100)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?

  evaluations TrainingRuleEvaluation[]

  @@index([category])
  @@index([isActive])
  @@index([department])
  @@map("training_rules")
}

// Scoring categories for weighted call quality scoring
model ScoringCategory {
  id        String   @id @default(cuid())
  name      String   @unique // e.g. "compliance", "customer_service", "sales"
  label     String   // Display name, e.g. "Customer Service"
  weight    Int      @default(100) // Weight percentage (0-100), all categories should sum to 100
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("scoring_categories")
}

// Per-call training rule evaluation results
model TrainingRuleEvaluation {
  id             String   @id @default(cuid())
  callAnalysisId String
  trainingRuleId String
  passed         Boolean  // Did the agent pass this rule?
  score          Int      @default(0) // 0-10 scale
  reasoning      String?  @db.Text // LLM's reasoning
  evidence       String?  @db.Text // Relevant transcript excerpt
  createdAt      DateTime @default(now())

  callAnalysis CallAnalysis @relation(fields: [callAnalysisId], references: [id], onDelete: Cascade)
  trainingRule TrainingRule @relation(fields: [trainingRuleId], references: [id])

  @@unique([callAnalysisId, trainingRuleId])
  @@index([callAnalysisId])
  @@index([trainingRuleId])
  @@map("training_rule_evaluations")
}

// Keyword alert instances when triggers are matched
model KeywordAlert {
  id          String   @id @default(cuid())
  callId      String
  triggerId   String
  agentId     String?
  matchedText String
  context     String   @db.Text
  reviewedAt  DateTime?
  reviewedBy  String?
  createdAt   DateTime @default(now())

  call    Call                     @relation(fields: [callId], references: [id])
  trigger DepartmentKeywordTrigger @relation(fields: [triggerId], references: [id])
  agent   Agent?                   @relation(fields: [agentId], references: [id])

  @@index([callId])
  @@index([triggerId])
  @@index([agentId])
  @@index([reviewedAt])
  @@map("keyword_alerts")
}

// Sentiment alert configuration â€” defines what triggers a sentiment alert
model SentimentAlertConfig {
  id              String   @id @default(cuid())
  name            String   // e.g. "Negative Sentiment Alert"
  isActive        Boolean  @default(true)
  // Trigger conditions (any matching condition triggers)
  sentimentValues String[] // e.g. ["Negative", "Very Negative"]
  frustrationMin  String?  // Minimum frustration level: "Medium", "High"
  // Actions
  flagForReview   Boolean  @default(true)
  notifyEmails    String[] // Email addresses to notify (future use)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("sentiment_alert_configs")
}

// Sentiment alert instances created when a call matches an alert config
model SentimentAlert {
  id              String    @id @default(cuid())
  callId          String
  callAnalysisId  String
  configId        String?   // Which config triggered this
  alertType       String    // "negative_sentiment", "high_frustration", "manual"
  severity        String    // "warning", "critical"
  sentiment       String?   // The actual sentiment value
  frustration     String?   // The actual frustration level
  reviewedAt      DateTime?
  reviewedBy      String?
  reviewNotes     String?   @db.Text
  dismissedAt     DateTime?
  createdAt       DateTime  @default(now())

  call            Call      @relation(fields: [callId], references: [id])

  @@index([callId])
  @@index([alertType])
  @@index([reviewedAt])
  @@index([dismissedAt])
  @@map("sentiment_alerts")
}

// Per-user access to specific agents' calls (granular call visibility)
model UserAgentAccess {
  id        String    @id @default(cuid())
  userId    String
  agentId   String
  grantedAt DateTime  @default(now())
  grantedBy String?   // Admin who granted access

  user      EntraUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent     Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([userId, agentId])
  @@index([userId])
  @@index([agentId])
  @@map("user_agent_access")
}
