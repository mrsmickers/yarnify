# The Oracle - Agent Briefing Document

> This document provides everything a sub-agent needs to work on The Oracle codebase autonomously.

## Project Overview

**The Oracle** is a call analysis platform for Ingenio Technologies (a UK MSP). It processes VoIP call recordings through an LLM pipeline (transcription → refinement → analysis) and presents results in a web dashboard.

**Tech Stack:**
- **Backend:** NestJS (TypeScript), Prisma ORM, PostgreSQL + pgvector, Redis + BullMQ
- **Frontend:** React (Vite), TanStack React Query, shadcn/ui components, Tailwind CSS
- **Auth:** Microsoft Entra ID SSO → JWT sessions
- **LLM:** OpenAI Whisper (transcription), NVIDIA Kimi-k2 (refinement + analysis), OpenAI gpt-5-mini (fallback)
- **Deployment:** Coolify on self-hosted Proxmox, Cloudflare Tunnel

## Repository Structure

```
/home/simon/projects/yarnify/
├── apps/
│   ├── api/                          # NestJS backend
│   │   ├── prisma/
│   │   │   └── schema.prisma         # Database schema
│   │   ├── generated/prisma/         # Prisma client (auto-generated)
│   │   └── src/
│   │       ├── app.module.ts         # Root module
│   │       ├── main.ts               # Entry point
│   │       └── modules/
│   │           ├── admin/            # Admin CRUD (users, agents, system)
│   │           ├── auth/             # Entra SSO, JWT, guards
│   │           ├── call-analysis/    # Core analysis pipeline
│   │           ├── connectwise-manage/ # CW PSA integration
│   │           ├── embedding/        # OpenAI embeddings
│   │           ├── nvidia/           # NVIDIA NIM (Kimi-k2)
│   │           ├── openai/           # OpenAI service
│   │           ├── prisma/           # Prisma service
│   │           ├── prompt-management/ # Prompt CRUD + LLM config
│   │           ├── storage/          # Local file storage
│   │           ├── text-chunking/    # Transcript chunking
│   │           ├── transcription/    # Whisper + refinement
│   │           └── voip/             # NTA VoIP polling
│   └── frontend/                     # React frontend
│       ├── orval.config.ts           # API client generator config
│       └── src/
│           ├── api/
│           │   ├── api-client.ts     # Auto-generated (orval) - DO NOT EDIT
│           │   └── axios-instance.ts # Custom axios + session management
│           ├── components/
│           │   ├── layout/
│           │   │   ├── AppShell.tsx   # Sidebar + main layout
│           │   │   └── PageHeader.tsx # Reusable page header
│           │   ├── ui/               # shadcn/ui components
│           │   └── Navigation.tsx    # Legacy top nav (replaced by AppShell sidebar)
│           ├── config/routes.tsx      # Route definitions
│           ├── pages/                 # Page components
│           └── theme/                 # Theme provider
└── docs/
    ├── PLAN.md                       # Feature roadmap
    ├── ENVIRONMENTS.md               # Staging/prod details
    └── INGENIO_UI_SYSTEM_GUIDE.md    # UI design system
```

## Key Conventions

### Backend
- **Modules:** Each feature is a NestJS module with controller, service, DTOs
- **Validation:** Zod schemas + `nestjs-zod` `ZodValidationPipe`
- **Auth guards:** `@UseGuards(AuthGuard('jwt'), RolesGuard)` + `@Roles('admin')` for admin routes
- **API prefix:** All routes under `/api/v1/` (configured in main.ts)
- **Prisma:** Schema at `apps/api/prisma/schema.prisma`, client generated to `apps/api/generated/prisma/`
- **After schema changes:** Run `npx prisma migrate dev --name <name>` then `npx prisma generate`

### Frontend
- **API client:** Generated by Orval from Swagger spec — BUT many pages use raw `axiosInstance` calls directly (both patterns are acceptable)
- **UI components:** shadcn/ui in `components/ui/` — use existing components (Card, Button, Dialog, Select, Input, Textarea, Badge, Table, etc.)
- **Styling:** Tailwind CSS with Ingenio design tokens (see `INGENIO_UI_SYSTEM_GUIDE.md`)
- **Routes:** Defined in `src/config/routes.tsx` — add new routes there
- **Sidebar nav:** Defined in `src/components/layout/AppShell.tsx` — add nav items in `workspaceNav` or `adminNav` objects
- **Toast notifications:** Use `toast` from `sonner` (already imported in most pages)
- **State:** URL search params for filters (React Router `useSearchParams`), React Query for server state

### Design Tokens (Quick Ref)
- **Primary navy:** `#222E40` / `#1C2533`
- **Accent yellow:** `#DEDC00`
- **Hover yellow:** `#F8AB08`
- **Cards dark:** `border-border/80 bg-card/70 backdrop-blur-sm dark:border-[#242F3F]`
- **Page header pattern:** Use `<PageHeader title="..." description="..." actions={...} />`
- **Active CTA:** `className="bg-[#DEDC00] text-[#1C2533] hover:bg-[#F8AB08]"`

## Auth System

- Microsoft Entra ID SSO (OAuth2 + PKCE)
- JWT stored in httpOnly cookie
- `AuthGuard('jwt')` validates the cookie
- `RolesGuard` + `@Roles('admin')` for admin-only routes
- User roles stored in `entra_users.role` ('admin' or 'user')
- **STAGING_API_KEY:** Add to staging env for bypassing auth during testing (see auth bypass section below)

## Database Models (Key)

- **Company** — CW company reference (name, connectwiseId)
- **Agent** — VoIP agent (name, extension, optional entraUserId link)
- **Call** — Call record with status, direction, metadata, links to analysis
- **CallAnalysis** — LLM analysis output (JSON data field)
- **EntraUser** — SSO user (oid, email, role, department)
- **PromptTemplate** — Editable prompts (useCase, content, isActive, version)
- **LLMConfiguration** — LLM settings per use case (model, provider, settings JSON)
- **DepartmentKeywordTrigger** — Keyword triggers for training alerts
- **KeywordAlert** — Triggered alert instances

## Existing Admin Pages

| Route | Page | Purpose |
|-------|------|---------|
| `/admin` | AdminConsolePage | Overview cards (placeholder) |
| `/admin/users` | UserManagementPage | Entra user CRUD |
| `/admin/agents` | AgentManagementPage | VoIP agent management |
| `/admin/prompts` | PromptManagementPage | Prompt template CRUD |
| `/admin/llms` | LLMManagementPage | LLM config per use case |
| `/admin/api-credentials` | ApiCredentialsPage | API key management |

## Prompt System (Current State)

**Use cases defined:**
- `TRANSCRIPTION` — Whisper model selection
- `TRANSCRIPTION_REFINEMENT` — Transcript formatting prompt
- `CALL_ANALYSIS` — Main analysis prompt
- `CUSTOM` — Catch-all

**How prompts are loaded:**
1. Service calls `promptService.findActiveByUseCase('CALL_ANALYSIS')`
2. If found, uses DB prompt content
3. If not, falls back to hardcoded default in code

**Hardcoded prompts (to be migrated to DB + variable system):**
- `apps/api/src/modules/call-analysis/prompt.ts` — `instructions` (call analysis system prompt)
- `apps/api/src/modules/transcription/transcription.service.ts` — refinement system prompt (inline)
- `apps/api/src/modules/call-analysis/call-analysis.service.ts` — agent identification prompt (inline in `identifyAgentFromTranscript()`)

**Variable injection (current approach):**
- `callContext` object appended to refinement prompt with agent name + company name
- `OWN_COMPANY_NAME` env var used in processing consumer
- Company name + phone injected into analysis prompt in consumer

## Git Workflow

- **Branch:** `develop` (all work goes here)
- **Push:** `git add . && git commit -m "..." && git push origin develop`
- **Deploy:** After push, trigger Coolify redeploy via API
- **No PRs needed** — solo dev workflow

## Coolify Deploy

```bash
# Trigger staging deploy
curl -s -X POST "http://100.99.183.58:8000/api/v1/applications/d4k0k00cwoog4kc0c4884kgk/restart" \
  -H "Authorization: Bearer $COOLIFY_TOKEN" \
  -H "Content-Type: application/json"
```

Wait 5-6 minutes for build + deploy.

## Testing Endpoints

```bash
# Test API (with auth bypass if configured)
curl -s https://staging-oracle.ingeniotech.co.uk/api/v1/admin/prompts \
  -H "X-Staging-Api-Key: <key>"

# Trigger VoIP processing (pull 5 calls)
curl -s https://staging-oracle.ingeniotech.co.uk/api/v1/voip/recordings/process?limit=5 \
  -H "X-Staging-Api-Key: <key>"
```

## Ingenio Technologies Company Context

For Feature #3 (Our Company Info), here's the real company data:

- **Name:** Ingenio Technologies Ltd
- **Industry:** IT Managed Services Provider (MSP)
- **Location:** Brighton, East Sussex, UK
- **Founded:** [check website]
- **Size:** ~14 staff, ~53 clients
- **Services:** IT support, cybersecurity, cloud services, telephony, consultancy
- **Website:** https://ingeniotech.co.uk
- **Brand voice:** Professional, approachable, credible

This should be stored in a DB-backed admin settings model, not hardcoded.
